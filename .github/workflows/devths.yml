name: Devths-AI CICD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [develop, release, main]

env:
  PYTHON_VERSION: '3.10'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  # S3 ë²„í‚· í™˜ê²½ë³„ ë¶„ë¦¬
  S3_BUCKET: ${{ github.ref_name == 'main' && secrets.AWS_S3_BUCKET_PROD || secrets.AWS_S3_BUCKET }}
  S3_PREFIX: AI/${{ github.ref_name }}
  CODEDEPLOY_APP_NAME: ${{ secrets.CODEDEPLOY_APP_NAME }}
  CODEDEPLOY_DEPLOYMENT_GROUP: ${{ github.ref_name == 'main' && secrets.CODEDEPLOY_GROUP_NAME_PROD || (github.ref_name == 'release' && secrets.CODEDEPLOY_GROUP_NAME_STAGING || secrets.CODEDEPLOY_GROUP_NAME_DEV) }}

jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Ruff)
  lint:
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì¹˜
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Poetry ì„¤ì¹˜
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Poetry ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: poetry install --with dev

      - name: Ruff Lint ê²€ì‚¬
        run: poetry run ruff check app/

      - name: Ruff Format ê²€ì‚¬
        run: poetry run ruff format --check app/

  # 2. ì •ì  ë¶„ì„ (CodeQL)
  static-analysis:
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: CodeQL ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v3

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê²°ê³¼ í™•ì¸ ë° ì°¨ë‹¨
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â³ ë¶„ì„ ê²°ê³¼ê°€ GitHubì— ë°˜ì˜ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ (10ì´ˆ)..."
          sleep 10

          # 1. í˜„ì¬ ì´ë²¤íŠ¸ê°€ pushì¸ì§€ prì¸ì§€ì— ë”°ë¼ ê²€ìƒ‰í•  REF ì„¤ì •
          CURRENT_REF="${{ github.ref }}"
          echo "ğŸ“ í˜„ì¬ Ref: $CURRENT_REF"

          # 2. API í˜¸ì¶œí•˜ì—¬ High/Critical ë“±ê¸‰ì˜ Open ìƒíƒœì¸ ì•Œë¦¼ ì¡°íšŒ
          ALERTS=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=$CURRENT_REF" \
            --jq '[.[] | select(.rule.security_severity_level == "high" or .rule.security_severity_level == "critical")]')

          COUNT=$(echo "$ALERTS" | jq 'length')

          if [ "$COUNT" -gt 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨: ê³ ìœ„í—˜(High/Critical) ì·¨ì•½ì  $COUNTê°œ ë°œê²¬"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$ALERTS" | jq -r '.[] | "- [\(.rule.security_severity_level)] \(.rule.description) \n   ìœ„ì¹˜: \(.most_recent_instance.location.path)"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          else
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼: í˜„ì¬ ì»¤ë°‹($CURRENT_REF)ì€ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

  # 3. ì˜ì¡´ì„± ë° Import ê²€ì¦
  validate:
    name: validate
    runs-on: ubuntu-22.04
    needs: [lint, static-analysis]
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íŒŒì´ì¬ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Poetry ì„¤ì¹˜
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Poetry ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: poetry install

      - name: Python Import ê²€ì¦
        run: |
          poetry run python -c "import app.main; print('âœ… Main app imports successfully')"

  # 4. ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ë° S3 ì—…ë¡œë“œ
  # - develop: ì¼ë°˜ ë°°í¬ (ìë™)
  # - release: ë¸”ë£¨/ê·¸ë¦° ë°°í¬ (ìë™)
  # - main: ì•„í‹°íŒ©íŠ¸ë§Œ ìƒì„±/ì—…ë¡œë“œ, ë°°í¬ëŠ” ìˆ˜ë™ ì›Œí¬í”Œë¡œìš° ì‚¬ìš©
  build:
    name: build
    runs-on: ubuntu-22.04
    needs: [validate]
    outputs:
      deployment_id: ${{ steps.codedeploy.outputs.deployment_id }}
      deployment_status: ${{ steps.codedeploy.outputs.deployment_status }}
      deployment_error: ${{ steps.codedeploy.outputs.deployment_error }}
      s3_key: ${{ steps.upload.outputs.s3_key }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
        id: timestamp
        run: |
          # SHAì˜ ì• 7ìë¦¬ë§Œ ë³€ìˆ˜ì— ì €ì¥
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          # ë‚ ì§œì™€ SHORT_SHAë¥¼ ê²°í•©í•˜ì—¬ OUTPUTì— ì €ì¥
          echo "value=$(date +'%Y%m%d_%H%M%S')-$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
        id: package
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          ARTIFACT_NAME="${{ steps.timestamp.outputs.value }}.zip"
          mkdir -p deploy-package

          # í•„ìš”í•œ íŒŒì¼ë“¤ ë³µì‚¬
          cp -r app/ deploy-package/
          cp -r deploy/ deploy-package/
          cp pyproject.toml deploy-package/
          cp poetry.lock deploy-package/
          cp appspec.yml deploy-package/
          cp .env.example deploy-package/

          # ë¸Œëœì¹˜ ì •ë³´ ë° ë°°í¬ ê·¸ë£¹ì„ í¬í•¨í•œ ë°°í¬ í™˜ê²½ íŒŒì¼ ìƒì„±
          echo "export DEPLOY_BRANCH=\"${{ github.ref_name }}\"" > deploy-package/.deploy-env
          echo "export DEPLOY_TIMESTAMP=\"${{ steps.timestamp.outputs.value }}\"" >> deploy-package/.deploy-env
          echo "export DEPLOY_SHA=\"${{ github.sha }}\"" >> deploy-package/.deploy-env
          echo "export CODEDEPLOY_DEPLOYMENT_GROUP=\"${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }}\"" >> deploy-package/.deploy-env

          echo "âœ… Deploy environment file created"
          cat deploy-package/.deploy-env

          # ZIP ì••ì¶•
          cd deploy-package
          zip -r ../$ARTIFACT_NAME .
          cd ..

          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Package created: $ARTIFACT_NAME"
          ls -lh $ARTIFACT_NAME

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: S3ì— ì—…ë¡œë“œ
        id: upload
        run: |
          echo "â˜ï¸ Uploading to S3..."
          ARTIFACT_NAME="${{ steps.package.outputs.artifact_name }}"
          S3_KEY="${{ env.S3_PREFIX }}/$ARTIFACT_NAME"
          aws s3 cp $ARTIFACT_NAME \
            s3://${{ env.S3_BUCKET }}/$S3_KEY
          echo "s3_key=$S3_KEY" >> $GITHUB_OUTPUT

          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Artifact uploaded to Production S3 bucket"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ To deploy to production:"
            echo "   1. Go to: Actions > Devths-AI ìš´ì˜ ë°°í¬ (Manual)"
            echo "   2. Click 'Run workflow'"
            echo "   3. Enter artifact key: $S3_KEY"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âœ… Upload complete"
          fi

      - name: CodeDeploy ë°°í¬ ì‹œì‘ (develop - ì¼ë°˜ ë°°í¬)
        id: codedeploy-dev
        if: github.ref_name == 'develop'
        run: |
          echo "ğŸš€ Starting CodeDeploy deployment (Standard)..."
          S3_KEY="${{ steps.upload.outputs.s3_key }}"
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CODEDEPLOY_APP_NAME }} \
            --deployment-group-name ${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }} \
            --s3-location bucket=${{ env.S3_BUCKET }},key=$S3_KEY,bundleType=zip \
            --description "Deploy from GitHub Actions - ${{ github.ref_name }} branch" \
            --query 'deploymentId' \
            --output text)

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployment started: $DEPLOYMENT_ID"

          # ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
          echo "â³ Waiting for deployment to complete..."
          if aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID; then
            echo "deployment_status=Success" >> $GITHUB_OUTPUT
            echo "âœ… Deployment completed successfully!"
          else
            ERROR_MSG=$(aws deploy get-deployment --deployment-id $DEPLOYMENT_ID --query 'deploymentInfo.errorInformation.message' --output text 2>&1 || echo "Unknown error")
            echo "deployment_status=Failed" >> $GITHUB_OUTPUT
            echo "deployment_error=$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "âŒ Deployment failed: $ERROR_MSG"
            exit 1
          fi

      - name: CodeDeploy ë°°í¬ ì‹œì‘ (release - ë¸”ë£¨/ê·¸ë¦°)
        id: codedeploy-stg
        if: github.ref_name == 'release'
        run: |
          echo "ğŸ”µğŸŸ¢ Starting CodeDeploy deployment (Blue/Green)..."
          S3_KEY="${{ steps.upload.outputs.s3_key }}"
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CODEDEPLOY_APP_NAME }} \
            --deployment-group-name ${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }} \
            --s3-location bucket=${{ env.S3_BUCKET }},key=$S3_KEY,bundleType=zip \
            --description "Deploy from GitHub Actions - ${{ github.ref_name }} branch (Blue/Green)" \
            --query 'deploymentId' \
            --output text)

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Blue/Green Deployment started: $DEPLOYMENT_ID"

          # ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
          echo "â³ Waiting for Blue/Green deployment to complete..."
          if aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID; then
            echo "deployment_status=Success" >> $GITHUB_OUTPUT
            echo "âœ… Blue/Green Deployment completed successfully!"
          else
            ERROR_MSG=$(aws deploy get-deployment --deployment-id $DEPLOYMENT_ID --query 'deploymentInfo.errorInformation.message' --output text 2>&1 || echo "Unknown error")
            echo "deployment_status=Failed" >> $GITHUB_OUTPUT
            echo "deployment_error=$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "âŒ Blue/Green Deployment failed: $ERROR_MSG"
            exit 1
          fi

      - name: Set deployment outputs
        id: codedeploy
        run: |
          if [ "${{ github.ref_name }}" == "develop" ]; then
            echo "deployment_id=${{ steps.codedeploy-dev.outputs.deployment_id }}" >> $GITHUB_OUTPUT
            echo "deployment_status=${{ steps.codedeploy-dev.outputs.deployment_status }}" >> $GITHUB_OUTPUT
            echo "deployment_error=${{ steps.codedeploy-dev.outputs.deployment_error }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" == "release" ]; then
            echo "deployment_id=${{ steps.codedeploy-stg.outputs.deployment_id }}" >> $GITHUB_OUTPUT
            echo "deployment_status=${{ steps.codedeploy-stg.outputs.deployment_status }}" >> $GITHUB_OUTPUT
            echo "deployment_error=${{ steps.codedeploy-stg.outputs.deployment_error }}" >> $GITHUB_OUTPUT
          fi

  # 5. ë””ìŠ¤ì½”ë“œ í†µí•© ì•Œë¦¼ - CI
  notify-discord-ci:
    runs-on: ubuntu-22.04
    needs: [lint, static-analysis, validate, build]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # 1. ì»¤ë°‹ ë©”ì‹œì§€ ì¶”ì¶œ (Push ì œëª© ëŒ€ìš©)
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "title=$COMMIT_MSG" >> $GITHUB_OUTPUT

          # 2. ë¸Œëœì¹˜ ì •ë³´
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ github.ref_name == 'main' && secrets.DISCORD_WEBHOOK_PROD_URL || secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
          status: ${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.validate.result == 'success' && needs.build.result == 'success') && 'success' || 'failure' }}
          title: "${{ steps.prep.outputs.branch }} CI ê²°ê³¼ [${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.validate.result == 'success' && needs.build.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ì»¤ë°‹ ë©”ì‹œì§€**: ${{ steps.prep.outputs.title }}
            **ë¸Œëœì¹˜**: `${{ steps.prep.outputs.branch }}`
            **í™˜ê²½**: ${{ github.ref_name == 'main' && 'ğŸš€ ìš´ì˜(PROD)' || (github.ref_name == 'release' && 'ğŸ§ª ìŠ¤í…Œì´ì§•(STAGING)' || 'ğŸ› ï¸ ê°œë°œ(DEV)') }}

            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Lint/Format: ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }}
            - Static Analysis: ${{ needs.static-analysis.result == 'success' && 'âœ…' || 'âŒ' }}
            - Validation: ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }}
            - Build: ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }}

            **ğŸª£ S3 Key**: `${{ needs.build.outputs.s3_key }}`

            **ğŸ”— ë§í¬**: [ì»¤ë°‹ í™•ì¸í•˜ê¸°](${{ github.event.repository.html_url }}/commit/${{ github.sha }})

          color: "${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.validate.result == 'success' && needs.build.result == 'success') && 65280 || 16711680 }}"
          username: GitHub AI CI Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png

  # 6. ë””ìŠ¤ì½”ë“œ í†µí•© ì•Œë¦¼ - CD
  notify-discord-cd:
    runs-on: ubuntu-22.04
    needs: [build]
    if: always() && needs.build.result != 'skipped' && (github.ref_name == 'develop' || github.ref_name == 'release')
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "title=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ ì „ì†¡
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ github.ref_name == 'main' && secrets.DISCORD_WEBHOOK_PROD_URL || secrets.DISCORD_WEBHOOK_NON_PROD_URL }}
          status: ${{ needs.build.result == 'success' && 'success' || 'failure' }}
          title: "${{ steps.prep.outputs.branch }} CD ê²°ê³¼ [${{ needs.build.result == 'success' && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **ì»¤ë°‹ ë©”ì‹œì§€**: ${{ steps.prep.outputs.title }}
            **ë¸Œëœì¹˜**: `${{ steps.prep.outputs.branch }}`
            **í™˜ê²½**: ${{ github.ref_name == 'main' && 'ğŸš€ ìš´ì˜(PROD)' || (github.ref_name == 'release' && 'ğŸ§ª ìŠ¤í…Œì´ì§•(STAGING)' || 'ğŸ› ï¸ ê°œë°œ(DEV)') }}

            **ğŸ“¦ ì•„í‹°íŒ©íŠ¸**: `${{ needs.build.outputs.artifact_name }}`
            **ğŸª£ S3 Key**: `${{ needs.build.outputs.s3_key }}`
            **ğŸš€ ë°°í¬ ê²°ê³¼**: ${{ needs.build.outputs.deployment_status || 'N/A' }}
            **ğŸ†” Deployment ID**: `${{ needs.build.outputs.deployment_id || 'N/A' }}`
            **ğŸ§¾ ì—ëŸ¬**: ${{ needs.build.outputs.deployment_error || 'ì—†ìŒ' }}

            **ğŸ”— ë§í¬**: [ì»¤ë°‹ í™•ì¸í•˜ê¸°](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
          color: "${{ needs.build.result == 'success' && 65280 || 16711680 }}"
          username: GitHub AI Deploy Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
