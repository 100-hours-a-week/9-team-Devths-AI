name: Devths-AI CI íŒŒì´í”„ë¼ì¸

on:
  pull_request:
    branches: [develop, release, main]

env:
  PYTHON_VERSION: '3.10'

jobs:
  # 0. main ë¸Œëœì¹˜ PR ê°€ë“œ
  main-branch-guard:
    runs-on: ubuntu-22.04
    steps:
      - name: main PR ë¸Œëœì¹˜ ê²€ì¦
        run: |
          BASE="${{ github.event.pull_request.base.ref }}"
          HEAD="${{ github.event.pull_request.head.ref }}"

          echo "ğŸ“Œ ëŒ€ìƒ ë¸Œëœì¹˜: $BASE"
          echo "ğŸ“Œ ì†ŒìŠ¤ ë¸Œëœì¹˜: $HEAD"

          # mainì´ ì•„ë‹ ë• í†µê³¼
          if [ "$BASE" != "main" ]; then
            echo "âœ… ë¸Œëœì¹˜ ì •ì±… í†µê³¼ (main ì•„ë‹˜)"
            exit 0
          fi

          # mainì¼ ë•Œ í—ˆìš© ë¸Œëœì¹˜: release, hotfix/*
          if [[ "$HEAD" =~ ^release$ || "$HEAD" =~ ^hotfix\/.+$ ]]; then
            echo "âœ… ë¸Œëœì¹˜ ì •ì±… í†µê³¼ (í—ˆìš©ëœ ì†ŒìŠ¤ ë¸Œëœì¹˜)"
            exit 0
          fi

          echo "âŒ ì •ì±… ìœ„ë°˜: mainì—ëŠ” release ë˜ëŠ” hotfix/* ë¸Œëœì¹˜ë§Œ PR ê°€ëŠ¥"
          exit 1

  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Ruff)
  lint:
    needs: [main-branch-guard]
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì¹˜
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Poetry ì„¤ì¹˜
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Poetry ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: poetry install --with dev

      - name: Ruff Lint ê²€ì‚¬
        run: poetry run ruff check app/

      - name: Ruff Format ê²€ì‚¬
        run: poetry run ruff format --check app/

  # 2. ì •ì  ë¶„ì„ (CodeQL)
  static-analysis:
    needs: [main-branch-guard]
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:

      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: ë¶„ì„ ìˆ˜í–‰
        uses: github/codeql-action/analyze@v3

      - name: ë³´ì•ˆ ì·¨ì•½ì  ê²°ê³¼ í™•ì¸ ë° ì°¨ë‹¨
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â³ ë¶„ì„ ê²°ê³¼ê°€ GitHubì— ë°˜ì˜ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ (10ì´ˆ)..."
          sleep 10

          # 1. í˜„ì¬ ì´ë²¤íŠ¸ê°€ pushì¸ì§€ prì¸ì§€ì— ë”°ë¼ ê²€ìƒ‰í•  REF ì„¤ì •
          # GITHUB_REFëŠ” pushì¼ ë• refs/heads/branchëª…, PRì¼ ë• refs/pull/ë²ˆí˜¸/mergeê°€ ë©ë‹ˆë‹¤.
          CURRENT_REF="${{ github.ref }}"
          echo "ğŸ“ í˜„ì¬ Ref: $CURRENT_REF"

          # 2. API í˜¸ì¶œí•˜ì—¬ High/Critical ë“±ê¸‰ì˜ Open ìƒíƒœì¸ ì•Œë¦¼ ì¡°íšŒ
          ALERTS=$(gh api "repos/${{ github.repository }}/code-scanning/alerts?tool_name=CodeQL&state=open&ref=$CURRENT_REF" \
            --jq '[.[] | select(.rule.security_severity_level == "high" or .rule.security_severity_level == "critical")]')

          COUNT=$(echo "$ALERTS" | jq 'length')

          if [ "$COUNT" -gt 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨: ê³ ìœ„í—˜(High/Critical) ì·¨ì•½ì  $COUNTê°œ ë°œê²¬"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$ALERTS" | jq -r '.[] | "- [\(.rule.security_severity_level)] \(.rule.description) \n   ìœ„ì¹˜: \(.most_recent_instance.location.path)"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          else
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼: í˜„ì¬ ì»¤ë°‹($CURRENT_REF)ì€ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

  # 3. ì˜ì¡´ì„± ë° Import ê²€ì¦
  validate:
    name: validate
    needs: [lint, static-analysis]
    runs-on: ubuntu-22.04
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íŒŒì´ì¬ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Poetry ì„¤ì¹˜
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Poetry ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: poetry install

      - name: Python Import ê²€ì¦
        run: |
          poetry run python -c "import app.main; print('âœ… Main app imports successfully')"

  # 4. ë””ìŠ¤ì½”ë“œ í†µí•© ì•Œë¦¼
  notify-discord:
    name: notify
    runs-on: ubuntu-22.04
    needs: [main-branch-guard, lint, static-analysis, validate]
    if: always()
    steps:
      - name: ë°ì´í„° ì¤€ë¹„
        id: prep
        env:
          USER_MAP: ${{ secrets.USER_MAP_JSON }}
        run: |
          # ë¸Œëœì¹˜ ê°€ë“œ ì¬í‰ê°€ (mainì€ release/hotfix/*ë§Œ í—ˆìš©)
          BASE="${{ github.event.pull_request.base.ref }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          if [ "$BASE" == "main" ] && [[ ! "$HEAD" =~ ^release$ && ! "$HEAD" =~ ^hotfix\/.+$ ]]; then
            GUARD_ALLOWED=false
            GUARD_REASON="mainì—ëŠ” release ë˜ëŠ” hotfix/* ë¸Œëœì¹˜ë§Œ PR ê°€ëŠ¥"
          else
            GUARD_ALLOWED=true
            GUARD_REASON="ì •ì±… í†µê³¼"
          fi

          echo "branch_guard_allowed=$GUARD_ALLOWED" >> $GITHUB_OUTPUT
          echo "branch_guard_reason=$GUARD_REASON" >> $GITHUB_OUTPUT

          # 1. ì‘ì„±ì ë§¤í•‘
          LOGIN_ID="${{ github.event.pull_request.user.login }}"
          AUTHOR_TAG=$(echo "$USER_MAP" | jq -r --arg id "$LOGIN_ID" '.[$id] // $id')
          echo "author=$AUTHOR_TAG" >> $GITHUB_OUTPUT

          # 2. ë¦¬ë·°ì–´ ë§¤í•‘
          REVIEWERS_JSON='${{ toJson(github.event.pull_request.requested_reviewers) }}'
          REVIEWER_TAGS=$(echo "$REVIEWERS_JSON" | jq -r --argjson map "$USER_MAP" '
            [.[].login | ($map[.] // .)] | join(", ")
          ')
          echo "reviewers=${REVIEWER_TAGS:-ì—†ìŒ}" >> $GITHUB_OUTPUT

          # 3. ì‘ì—… ë‚´ìš© 
          PR_RAW_BODY=$(cat << 'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          )

          # í•„ìš”ì—†ëŠ” ë¬¸êµ¬ ì‚­ì œ
          DESC=$(echo "$PR_RAW_BODY" | \
            perl -0777 -pe 's///gs' | \
            sed 's/ì´ PRì—ì„œ ë³€ê²½ëœ ë‚´ìš©ì„ ê°„ëµíˆ ì‘ì„±í•´ì£¼ì„¸ìš”\.//g' | \
            sed -n '/## ğŸ“Œ ì‘ì—…í•œ ë‚´ìš©/,/## ğŸ” ì°¸ê³  ì‚¬í•­/p' | \
            sed '1d;$d' | \
            xargs | \
            head -c 300)
          echo "description=${DESC:-ë‚´ìš© ì—†ìŒ}" >> $GITHUB_OUTPUT

      - name: Discord ë¹Œë“œ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ steps.prep.outputs.branch_guard_allowed == 'true' && needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.validate.result == 'success' && 'success' || 'failure' }}
          title: "${{ github.event.pull_request.base.ref }} AI PR [${{ (needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.validate.result == 'success') && 'âœ…ì„±ê³µ' || 'âŒì‹¤íŒ¨' }}]"
          description: |
            **PR ì œëª©**: ${{ github.event.pull_request.title }}
            **ë¸Œëœì¹˜ ê°€ë“œ**: ${{ steps.prep.outputs.branch_guard_allowed == 'true' && 'âœ… í†µê³¼' || 'âŒ ì°¨ë‹¨' }} (ì´ìœ : ${{ steps.prep.outputs.branch_guard_reason }})
            **ì‘ì„±ì**: ${{ steps.prep.outputs.author }}
            **ë¦¬ë·°ì–´**: ${{ steps.prep.outputs.reviewers }}
            **ì‘ì—… ë‚´ìš©**: ${{ steps.prep.outputs.description }}...
            **ê²½ë¡œ**: `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`

            **ğŸ“Š ìƒì„¸ ê²°ê³¼**:
            - Branch Guard: ${{ steps.prep.outputs.branch_guard_allowed == 'true' && ' âœ…' || ' âŒ' }}
            - Lint: ${{ steps.prep.outputs.branch_guard_allowed == 'true' && (needs.lint.result == 'success' && 'âœ…' || 'âŒ') || ' âšªï¸ (ë¸Œëœì¹˜ ê°€ë“œ ì°¨ë‹¨)' }}
            - Static Analysis: ${{ steps.prep.outputs.branch_guard_allowed == 'true' && (needs.static-analysis.result == 'success' && 'âœ…' || 'âŒ') || ' âšªï¸ (ë¸Œëœì¹˜ ê°€ë“œ ì°¨ë‹¨)' }}
            - Validation: ${{ steps.prep.outputs.branch_guard_allowed == 'true' && (needs.validate.result == 'success' && 'âœ…' || 'âŒ') || ' âšªï¸ (ë¸Œëœì¹˜ ê°€ë“œ ì°¨ë‹¨)' }}

            ${{ needs.static-analysis.result != 'success' && 'âš ï¸ **ì •ì  ë¶„ì„ ì‹¤íŒ¨ë¡œ ì¸í•´ íŒŒì´í”„ë¼ì¸ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.**' || '' }}

            **ğŸ”— ë§í¬**: [PR í™•ì¸í•˜ê¸°](${{ github.event.pull_request.html_url }})
          color: "${{ steps.prep.outputs.branch_guard_allowed == 'true' && needs.lint.result == 'success' && needs.static-analysis.result == 'success' && needs.validate.result == 'success' && 65280 || 16711680 }}"
          username: GitHub PR Bot
          avatar_url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
